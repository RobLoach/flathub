id: net.lutris.Lutris.wine
runtime: net.lutris.Lutris
sdk: org.gnome.Sdk//3.32
build-extension: true
separate-locales: false
appstream-compose: false
build-options:
    prefix: /app/wine
    prepend-path: /app/wine/bin
    prepend-ld-library-path: /app/wine/lib
    prepend-pkg-config-path: /app/wine/lib/pkgconfig
    env:
      C_INCLUDE_PATH: /app/wine/include:/app/include
      CPLUS_INCLUDE_PATH: /app/wine/include:/app/include
    strip: true
    no-debuginfo: false
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /share/man
  - /share/applications
  - /lib/pkgconfig
  - /lib/cmake
modules:

  - name: wine
    build-options:
      config-opts:
        - --libdir=/app/wine/lib
      arch:
        x86_64:
          config-opts:
            - --enable-win64
    config-opts:
      - --disable-win16
      - --disable-tests
      - --with-x
      - --with-pulse
      - --without-hal
    post-install:
      - case $FLATPAK_ARCH in
          x86_64)
            mv $FLATPAK_DEST/bin/wineserver{,64}
          ;;
          i386)
            mv $FLATPAK_DEST/bin/wineserver{,32}
          ;;
        esac
    cleanup:
      - /share/man
      - /share/applications
    sources:
      - type: git
        url: "https://github.com/lutris/wine.git"
        branch: tkg
    modules:

      - name: vkd3d
        sources:
          - type: archive
            url: "https://dl.winehq.org/vkd3d/source/vkd3d-1.1.tar.xz"
            sha256: 495adc61cc80c65d54b2f5b52092ea05d3797cc2c17a610f0fc98457d2f56ab6
        modules:

          - name: SPIRV-Headers
            buildsystem: cmake-ninja
            sources:
              - type: git
                url: "https://github.com/KhronosGroup/SPIRV-Headers.git"
                commit: 8bea0a266ac9b718aa0818d9e3a47c0b77c2cb23

      - name: FAudio
        buildsystem: cmake-ninja
        config-opts:
          - -DFFMPEG=ON
        sources:
          - type: archive
            url: "https://github.com/FNA-XNA/FAudio/archive/19.02.tar.gz"
            sha256: 514dd03672aa0241a7eee29e207a594e86cc9954940205489a8299cd1395ffaf

  - name: wineserver
    buildsystem: simple
    build-commands:
      - ln -s $FLATPAK_DEST/wineserver $FLATPAK_DEST/bin/wineserver
      - case $FLATPAK_ARCH in
          x86_64)
            ln -s bin/wineserver64 $FLATPAK_DEST/wineserver
          ;;
          i386)
            ln -s bin/wineserver32 $FLATPAK_DEST/wineserver
          ;;
        esac

  - name: compat32
    only-arches:
      - x86_64
    buildsystem: simple
    build-commands:
      - mkdir -p $FLATPAK_DEST/compat32
      - ln -srv $FLATPAK_DEST/compat32/bin/wine $FLATPAK_DEST/bin/wine
      - ln -srv $FLATPAK_DEST/compat32/bin/wine-preloader $FLATPAK_DEST/bin/wine-preloader
      - ln -srv $FLATPAK_DEST/compat32/bin/wineserver32 $FLATPAK_DEST/bin/wineserver32

  - name: appdata
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: file
        path: net.lutris.Lutris.wine.metainfo.xml
